---
title: Mining Hamlet
author: Rafa
date: '2018-08-20'
slug: mining-hamlet
categories: []
tags: []
---



<pre class="r"><code>library(tidyr)
library(dplyr)
library(stringr)
library(ggplot2)

books &lt;- readRDS(&#39;../../static/data/shakespeare_plays.rds&#39;)
hamlet_title &lt;- &quot;Hamlet, Prince of Denmark&quot;

hamlet &lt;- books %&gt;%  
  filter(title == hamlet_title)


# ACT
# ACT I.
ACT_REGEX &lt;- regex(&quot;ACT ([IVX]+)\\.&quot;, ignore_case = TRUE)

# SCENE
# Scene I. Elsinore. A platform before the Castle.
SCENE_REGEX &lt;- regex(&quot;Scene ([IVX]+)\\.&quot;)

# CHAR
# Fran.
# Ham. Pol.
CHAR_REGEX &lt;- regex(&quot;^([A-Z][a-z]*)\\.&quot;)

# Stage Dir
# [Enter Horatio and Marcellus.]
STAGEDIR_REGEX &lt;- regex(&quot;(\\[.+\\])&quot;)



add_act_index &lt;- function(df) {
  df %&gt;% 
    mutate(act_num = str_match(text, ACT_REGEX)[,2],
           act_num = act_num %&gt;% as.roman %&gt;% as.integer) %&gt;% 
    fill(act_num)
}

add_scene_index &lt;- function(df) {
  df %&gt;% 
    mutate(scene_num = str_match(text, SCENE_REGEX)[,2] %&gt;% as.roman %&gt;% as.integer) %&gt;% 
    group_by(act_num) %&gt;% 
    fill(scene_num) %&gt;% 
    ungroup
}

hamlet_2 &lt;- hamlet %&gt;% 
  add_act_index %&gt;% 
  add_scene_index %&gt;%
  mutate(char_name = str_match(text, CHAR_REGEX)[,2]) %&gt;% 
  mutate(start_speech = !is.na(char_name) &amp; lag(text) == &quot;&quot;) %&gt;% 
  mutate(speech_idx = cumsum(start_speech)) %&gt;% 
  mutate(stage_dir = str_match(text, STAGEDIR_REGEX)[,2]) %&gt;% 
  filter(!is.na(scene_num)) %&gt;% 
  mutate(line = row_number()) %&gt;% 
  select(text, act_num, scene_num, char_name, start_speech, speech_idx, line)


# Build a df with speech, start line, length char
speeches_df &lt;- hamlet_2 %&gt;% 
  group_by(speech_idx) %&gt;% 
  summarise(act = first(act_num), scene = first(scene_num), 
            char_name = first(char_name), line = first(line),
            speech_length = as.integer(n()-2)) %&gt;% 
  group_by(char_name) %&gt;% 
  mutate(cum_lines = as.integer(cumsum(speech_length)))

# keep only the main 6 characters
top_n_speakers &lt;- function(df, n) {
  df %&gt;% 
    group_by(char_name) %&gt;% 
    summarize(lines = n()) %&gt;% 
    arrange(-lines) %&gt;% 
    head(n)
}

speakers &lt;- top_n_speakers(hamlet_2, 8)

speeches_df_main &lt;- speeches_df %&gt;% 
  filter(char_name %in% speakers$char_name) %&gt;% 
  filter(!is.na(char_name))
  


# Data for grid

# colors

col.pal &lt;- RColorBrewer::brewer.pal(8, &quot;Set2&quot;)


ggplot(speeches_df_main, aes(line, cum_lines, fill = char_name)) + 
  # geom_vline(data = scene_grid, aes(xintercept = line, color = &quot;Scenes&quot;),
  #                         linetype = &quot;dashed&quot;, size = 0.4) +
  # geom_vline(data = act_grid, aes(xintercept = line, color = &quot;Acts&quot;),
  #                         linetype = &quot;dashed&quot;, size = 0.5) +
  scale_color_manual(values = c( &quot;Acts&quot; = col.pal[1] , &quot;Scenes&quot; = col.pal[2])) +
  guides(colour = guide_legend(title = NULL)) +
  geom_area(alpha = 0.8) + 
  guides(fill = guide_legend(title = NULL)) +
  scale_fill_brewer(palette = &quot;Set2&quot;) + 
  labs(title = hamlet, subtitle = &quot;Lines by Character&quot;) + 
  xlab(&quot;Line&quot;) + 
  ylab(&quot;Spoken Lines&quot;) +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        panel.border = element_blank()) +
  scale_x_continuous(expand = c(0, 0)) + 
  scale_y_continuous(expand = c(0, 0))</code></pre>
<p><img src="/post/2018-08-20-mining-hamlet_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
