---
title: Mapeando Ingresos en las Ciudades de Uruguay
author: ''
date: '2019-04-13'
slug: mapeando-ingresos-en-las-ciudades-de-uruguay
categories: []
tags: []
---

```{r utils, echo=FALSE, message=FALSE, warning=FALSE}
library(rgdal)
library(tidyverse)
library(tmap)

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning=FALSE)

mapa_ingresos <- function(cod_loc, nom_loc, legend_pos = c("right","top")) {
  
  # segmento censal
  ine_seg_11 <- readOGR(dsn = '~/blog_data/mapas_vectoriales_ine/', layer = 'ine_seg_11')
  crswgs84 <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
  # proyeccion ine
  prj <- CRS("+proj=utm +zone=21 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs")
  proj4string(ine_seg_11) <- prj
  #ine_seg_11 <- spTransform(states, crswgs84)
  
  Sys.setlocale("LC_ALL", "UTF-8")
  ingresos_ech <- read_tsv("~/blog_data/H_2018_TERCEROS.dat") %>% 
    transmute(id       =as.character(numero),
              depto_id = dpto, 
              depto = nomdpto,
              localidad_id = as.numeric(locagr),
              localidad = nom_locagr,
              seccion_id = as.numeric(secc),
              segmento_id = as.numeric(segm),
              ingreso = YSVL)
  
  medianas <- ingresos_ech %>% 
    group_by(depto_id, seccion_id, segmento_id) %>% 
    summarize(mediana = median(ingreso))
  
  mapa_loc <- ine_seg_11[ine_seg_11$CODLOC == cod_loc,]
  
  mapa_loc@data <- mapa_loc@data %>% 
    left_join(medianas, by = c("DEPTO" = "depto_id",
                               "SECCION" = "seccion_id",
                               "SEGMENTO" = "segmento_id"))
  
  tm_shape(mapa_loc) +
    tm_fill(col = "mediana", 
            style="quantile", 
            textNA = "S/D",
            colorNA = "gray80",
            labels = c("0-20%", "20%-40%", "40%-60%", "60%-80%", "80%-100%"),
            title = "Quintiles de Ingreso") +
    tm_layout(nom_loc, legend.position = legend_pos,
              legend.text.size = 0.6,
              legend.title.size = 0.8, 
              title.size = 1)
}
```


En un [post anterior](https://www.blog.rlabuonora.com/2018/07/17/mapas/) hice un mapa de Montevideo combinando capas de Open Street View y Shapefiles publicados por el INE. Hace un tiempo que estoy trabajando sobre un curso de [Charlotte Wickham](https://www.cwick.co.nz/) sobre mapas y pensé en replicar el proyecto final del curso con datos de Uruguay.

La principal pregunta que me interesa contestar es ¿cómo es la distribución del ingreso en las ciudades de Uruguay? En Montevideo sabemos que la zona costera es donde se concentran los hogares de mayores ingresos (especialmente Carrasco y Pocitos).

Para visualizar esta estructura, linkeo los datos de la [Encuesta Continua de Hogares](http://ine.gub.uy/web/guest/encuesta-continua-de-hogares1) con un mapa de los segmentos censales del país.


```{r message=FALSE, echo=FALSE}
mapa_ingresos("1020", "Montevideo")
```

# El mapa

`readOGR` lee los archivos publicados por el INE como un objecto `SpatialPolygonsDataFrame`. 

```{r, message = FALSE, warning = FALSE}
# Cargar mapa
ine_seg_11 <- readOGR(dsn = '~/blog_data/mapas_vectoriales_ine/', 
                      layer = 'ine_seg_11')
class(ine_seg_11)

```


Este objeto es un `data.frame`. Cada fila corresponde a uno de los 4313 segmentos censales de Uruguay. Tiene 13 columnas, incluyendo el `AREA` y el `PERIMETER`, el departamento y la localidad donde se ubican.

```{r}
head(ine_seg_11@data)
```

Hasta acá sería un `data.frame` normal, pero también incluye una columna con la forma de cada segmento. Esto es lo que nos va a permitir crear un mapa con estos datos.

Para saber más sobre estos objetos, recomiendo el capítulo 2 de [Geocomputation with R](https://geocompr.robinlovelace.net/).



La ECH tiene los ingresos de los hogares identificados por segmento censal, por lo que podemos calcular la mediana de ingresos por segmento con `group_by` y `summarize` de `dplyr`:
```{r, warning=FALSE, message=FALSE}
Sys.setlocale("LC_ALL", "UTF-8")
ingresos_ech <- read_tsv("~/blog_data/H_2018_TERCEROS.dat") %>% 
  transmute(id       =as.character(numero),
            depto_id = dpto, 
            depto = nomdpto,
            localidad_id = as.numeric(locagr),
            localidad = nom_locagr,
            seccion_id = as.numeric(secc),
            segmento_id = as.numeric(segm),
            ingreso = YSVL)

medianas <- ingresos_ech %>% 
    group_by(depto_id, seccion_id, segmento_id) %>% 
    summarize(mediana = median(ingreso))
```

# Elegir una localidad
Una vez calculada esta estimación, elijo una localidad para subsetear el mapa
```{r}
# Salto es la localidad 1120
cod_loc <- "15120"
mapa_loc <- ine_seg_11[ine_seg_11$CODLOC == cod_loc,]
```

# Pegar las estimaciones
y linkeo el mapa con las medianas por sección:

```{r}
mapa_loc@data <- mapa_loc@data %>% 
    left_join(medianas, by = c("DEPTO" = "depto_id",
                               "SECCION" = "seccion_id",
                               "SEGMENTO" = "segmento_id"))

```

En el post anterior usé leaflet para hacer los mapas. Como Charlotte usa `tmap` voy a usar esa librería para hacer el choropleth:

```{r}
tm_shape(mapa_loc) +
    tm_fill(col = "mediana", 
            style="quantile", 
            textNA = "S/D",
            colorNA = "gray80",
            labels = c("0-20%", "20%-40%", "40%-60%", "60%-80%", "80%-100%"),
            title = "Quintiles de Ingreso") +
    tm_layout("Salto", legend.position = c("right", "top"),
              legend.text.size = 0.4,
              legend.title.size = 0.6, 
              title.size = 0.8)
```

# Una función

Para poder hacer el mapa para varias localidades, lo puse todo en una función, a la que hay que pasarle el nombre y el código de la localidad para que haga el mapa:

```{r}

mapa_ingresos <- function(cod_loc, nom_loc, legend_pos = c("right","top")) {
  
  # segmento censal
  ine_seg_11 <- readOGR(dsn = '~/blog_data/mapas_vectoriales_ine/', layer = 'ine_seg_11')
  crswgs84 <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
  # proyeccion ine
  prj <- CRS("+proj=utm +zone=21 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs")
  proj4string(ine_seg_11) <- prj
  #ine_seg_11 <- spTransform(states, crswgs84)
  
  Sys.setlocale("LC_ALL", "UTF-8")
  ingresos_ech <- read_tsv("~/blog_data/H_2018_TERCEROS.dat") %>% 
    transmute(id       =as.character(numero),
              depto_id = dpto, 
              depto = nomdpto,
              localidad_id = as.numeric(locagr),
              localidad = nom_locagr,
              seccion_id = as.numeric(secc),
              segmento_id = as.numeric(segm),
              ingreso = YSVL)
  
  medianas <- ingresos_ech %>% 
    group_by(depto_id, seccion_id, segmento_id) %>% 
    summarize(mediana = median(ingreso))
  
  mapa_loc <- ine_seg_11[ine_seg_11$CODLOC == cod_loc,]
  
  mapa_loc@data <- mapa_loc@data %>% 
    left_join(medianas, by = c("DEPTO" = "depto_id",
                               "SECCION" = "seccion_id",
                               "SEGMENTO" = "segmento_id"))
  
  tm_shape(mapa_loc) +
    tm_fill(col = "mediana", 
            style="quantile", 
            textNA = "S/D",
            colorNA = "gray80",
            labels = c("0-20%", "20%-40%", "40%-60%", "60%-80%", "80%-100%"),
            title = "Quintiles de Ingreso") +
    tm_layout(nom_loc, legend.position = legend_pos,
              legend.text.size = 0.6,
              legend.title.size = 0.8, 
              title.size = 1)
}
```

Para sacar varios mapas a la vez podemos usar `tmap_arrange`:
```{r}
tmap_arrange(
            mapa_ingresos("14320", "Rocha", c("left", "bottom")),
            mapa_ingresos("6220", "Durazno", c("left", "bottom")),
            mapa_ingresos("18220", "Tacuarembó", c("left", "bottom")),
            mapa_ingresos("9220", "Minas", c("left", "bottom")))
```

El problema más grande que le veo a estos mapas es que si no conocemos la ciudad es difícil entender el mapa. Para solucionar esto necesitaríamos agregarle referencias geográficas como calles o cuerpos de agua que permitan hacerse una idea de la forma de la ciudad. Dejo eso para otro post.